'use client';

import { useEffect, useState } from 'react';
import { useTranslations } from 'next-intl';
import { useWorkshopStore } from '@/lib/store';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';

interface VulnerabilityMunicipality {
  code: string;
  name: string;
  vulnerability: number;
}

interface VulnerabilityGroup {
  municipalities: VulnerabilityMunicipality[];
  averages: Record<string, number>;
  count: number;
}

interface ActionImpact {
  actionId: string;
  actionName: string;
  category: string;
  highVulnBenefit: number;
  lowVulnBenefit: number;
  disparity: number;
}

interface VulnerabilityData {
  highVulnerability: VulnerabilityGroup;
  lowVulnerability: VulnerabilityGroup;
  actionImpact: ActionImpact[];
  medianVulnerability: number;
}

// Dimension display order by category
const DIMENSION_ORDER = [
  'governance_general',
  'governance_climatic',
  'biodiversity',
  'natural_habitat',
  'pollination',
  'fire_risk',
  'flooding',
  'hydric_stress',
  'dengue',
  'diarrhea',
  'cv_mortality',
  'resp_hosp',
  'leishmaniasis',
  'poverty',
  'vulnerability',
];

// Category colors matching the app theme
const CATEGORY_FOR_DIMENSION: Record<string, string> = {
  governance_general: 'governance',
  governance_climatic: 'governance',
  biodiversity: 'biodiversity',
  natural_habitat: 'biodiversity',
  pollination: 'biodiversity',
  fire_risk: 'climate',
  flooding: 'climate',
  hydric_stress: 'climate',
  dengue: 'health',
  diarrhea: 'health',
  cv_mortality: 'health',
  resp_hosp: 'health',
  leishmaniasis: 'health',
  poverty: 'social',
  vulnerability: 'social',
};

const CATEGORY_COLORS: Record<string, string> = {
  governance: '#3B82F6',
  biodiversity: '#10B981',
  climate: '#F59E0B',
  health: '#EF4444',
  social: '#8B5CF6',
};

export default function VulnerabilityComparison() {
  const t = useTranslations('workshopFlow');
  const tLayers = useTranslations('layerNames');
  const tActions = useTranslations('actionNames');
  const { group } = useWorkshopStore();

  const [data, setData] = useState<VulnerabilityData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!group?.id) return;

    setLoading(true);
    setError(null);

    fetch(`/api/workshop/vulnerability-comparison/${group.id}`)
      .then((res) => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(setData)
      .catch((err) => setError(err.message))
      .finally(() => setLoading(false));
  }, [group?.id]);

  if (loading) {
    return (
      <Card className="mt-8 animate-pulse">
        <CardHeader className="bg-gradient-to-r from-red-50 to-green-50">
          <div className="h-6 bg-gray-200 rounded w-64" />
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="h-10 bg-gray-100 rounded" />
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error || !data) return null;

  const getDiffColor = (diff: number) => {
    const abs = Math.abs(diff);
    if (abs < 5) return 'text-gray-500';
    if (diff > 0) return 'text-red-600';
    return 'text-green-600';
  };

  const getDisparityLevel = (disparity: number) => {
    if (disparity >= 0.3) return 'high';
    if (disparity >= 0.15) return 'medium';
    return 'low';
  };

  const getDisparityBadge = (level: string) => {
    if (level === 'high') return 'bg-red-100 text-red-800 border-red-200';
    if (level === 'medium') return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    return 'bg-gray-100 text-gray-600 border-gray-200';
  };

  return (
    <Card className="mt-8 border-2 border-orange-200">
      <CardHeader className="bg-gradient-to-r from-red-50 to-green-50">
        <CardTitle className="text-lg flex items-center gap-2">
          <svg className="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          {t('vulnerabilityComparison')}
        </CardTitle>
      </CardHeader>
      <CardContent className="p-4 lg:p-6 space-y-4 lg:space-y-6">
        {/* Two group columns */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
          {/* High vulnerability */}
          <div className="bg-red-50 border border-red-200 rounded-lg p-3 lg:p-4">
            <h3 className="font-semibold text-red-800 mb-2 lg:mb-3 flex items-center gap-2 text-sm lg:text-base">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
              {t('highVulnerability')} ({data.highVulnerability.count})
            </h3>
            <div className="space-y-1 lg:space-y-1.5">
              {data.highVulnerability.municipalities
                .sort((a, b) => b.vulnerability - a.vulnerability)
                .map((m) => (
                  <div key={m.code} className="flex items-center justify-between text-xs lg:text-sm">
                    <span className="text-gray-800 truncate">{m.name}</span>
                    <Badge variant="outline" className="text-xs bg-red-100 border-red-300 text-red-700 ml-2">
                      {Math.round(m.vulnerability)}
                    </Badge>
                  </div>
                ))}
            </div>
          </div>

          {/* Low vulnerability */}
          <div className="bg-green-50 border border-green-200 rounded-lg p-3 lg:p-4">
            <h3 className="font-semibold text-green-800 mb-2 lg:mb-3 flex items-center gap-2 text-sm lg:text-base">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {t('lowVulnerability')} ({data.lowVulnerability.count})
            </h3>
            <div className="space-y-1 lg:space-y-1.5">
              {data.lowVulnerability.municipalities
                .sort((a, b) => a.vulnerability - b.vulnerability)
                .map((m) => (
                  <div key={m.code} className="flex items-center justify-between text-xs lg:text-sm">
                    <span className="text-gray-800 truncate">{m.name}</span>
                    <Badge variant="outline" className="text-xs bg-green-100 border-green-300 text-green-700 ml-2">
                      {Math.round(m.vulnerability)}
                    </Badge>
                  </div>
                ))}
            </div>
          </div>
        </div>

        {/* Dimension comparison table */}
        <div>
          <h4 className="font-semibold text-gray-700 mb-2 lg:mb-3 text-sm lg:text-base">{t('dimensionComparison')}</h4>
          <div className="overflow-x-auto rounded-lg border border-gray-200">
            <table className="w-full text-xs lg:text-sm">
              <thead>
                <tr className="bg-gray-50 border-b border-gray-200">
                  <th className="px-2 lg:px-4 py-2 text-left font-medium text-gray-600">{t('dimension')}</th>
                  <th className="px-2 lg:px-4 py-2 text-center font-medium text-red-600">{t('highVuln')}</th>
                  <th className="px-2 lg:px-4 py-2 text-center font-medium text-green-600">{t('lowVuln')}</th>
                  <th className="px-2 lg:px-4 py-2 text-center font-medium text-gray-600">{t('difference')}</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {DIMENSION_ORDER.filter(
                  (dim) => dim in data.highVulnerability.averages && dim in data.lowVulnerability.averages
                ).map((dim) => {
                  const high = data.highVulnerability.averages[dim];
                  const low = data.lowVulnerability.averages[dim];
                  const diff = high - low;
                  const category = CATEGORY_FOR_DIMENSION[dim];
                  const catColor = CATEGORY_COLORS[category];

                  return (
                    <tr key={dim} className="hover:bg-gray-50 transition-colors">
                      <td className="px-2 lg:px-4 py-2 font-medium text-gray-800">
                        <div className="flex items-center gap-1.5 lg:gap-2">
                          <div
                            className="w-2 h-2 rounded-full flex-shrink-0"
                            style={{ backgroundColor: catColor }}
                          />
                          <span className="truncate">{tLayers(dim)}</span>
                        </div>
                      </td>
                      <td className="px-2 lg:px-4 py-2 text-center tabular-nums">
                        {high.toFixed(1)}
                      </td>
                      <td className="px-2 lg:px-4 py-2 text-center tabular-nums">
                        {low.toFixed(1)}
                      </td>
                      <td className={`px-2 lg:px-4 py-2 text-center font-semibold tabular-nums ${getDiffColor(diff)}`}>
                        {diff > 0 ? '+' : ''}{diff.toFixed(1)}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>

        <Separator />

        {/* Action impact disparity */}
        <div>
          <h4 className="font-semibold text-gray-700 mb-2 lg:mb-3 text-sm lg:text-base">{t('actionImpactDisparity')}</h4>
          <div className="space-y-1.5 lg:space-y-2">
            {data.actionImpact.slice(0, 10).map((action) => {
              const level = getDisparityLevel(action.disparity);

              return (
                <div
                  key={action.actionId}
                  className="flex flex-col sm:flex-row sm:items-center sm:justify-between p-2.5 lg:p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors gap-1.5 sm:gap-0"
                >
                  <div className="flex-1 min-w-0">
                    <span className="text-xs lg:text-sm font-medium text-gray-800 truncate block">
                      {tActions(action.actionId)}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 lg:gap-3 ml-0 sm:ml-4">
                    <div className="hidden sm:flex items-center gap-1.5 text-xs">
                      <span className="text-red-600 font-medium w-10 text-right">
                        {(action.highVulnBenefit * 100).toFixed(0)}%
                      </span>
                      <div className="w-12 lg:w-16 h-2 bg-gray-200 rounded-full overflow-hidden flex">
                        <div
                          className="h-full bg-red-400 rounded-l-full"
                          style={{ width: `${action.highVulnBenefit * 100}%` }}
                        />
                      </div>
                      <div className="w-12 lg:w-16 h-2 bg-gray-200 rounded-full overflow-hidden flex justify-end">
                        <div
                          className="h-full bg-green-400 rounded-r-full"
                          style={{ width: `${action.lowVulnBenefit * 100}%` }}
                        />
                      </div>
                      <span className="text-green-600 font-medium w-10">
                        {(action.lowVulnBenefit * 100).toFixed(0)}%
                      </span>
                    </div>
                    {/* Mobile: compact bar */}
                    <div className="flex sm:hidden items-center gap-1 text-xs flex-1">
                      <span className="text-red-600 font-medium">{(action.highVulnBenefit * 100).toFixed(0)}%</span>
                      <div className="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden flex">
                        <div className="h-full bg-red-400" style={{ width: `${action.highVulnBenefit * 100}%` }} />
                      </div>
                      <div className="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden flex justify-end">
                        <div className="h-full bg-green-400" style={{ width: `${action.lowVulnBenefit * 100}%` }} />
                      </div>
                      <span className="text-green-600 font-medium">{(action.lowVulnBenefit * 100).toFixed(0)}%</span>
                    </div>
                    <Badge
                      variant="outline"
                      className={`text-xs min-w-[44px] lg:min-w-[52px] justify-center ${getDisparityBadge(level)}`}
                    >
                      {level === 'high' ? t('highDisparity') : level === 'medium' ? t('mediumDisparity') : t('lowDisparity')}
                    </Badge>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Interpretation */}
        <div className="p-3 lg:p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p className="text-xs lg:text-sm text-blue-900">
            <strong>{t('interpretation')}:</strong>{' '}
            {t('vulnerabilityInterpretation')}
          </p>
        </div>
      </CardContent>
    </Card>
  );
}
